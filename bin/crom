#!/usr/bin/env node

var fs = require("fs"),
    path = require("path"),
    crypto = require("crypto");

var Registry = require("../lib/Registry"),
    Root = require("../lib/Root");

var query = "d3-format";

require("../plugin/GitHub");

Root.init(".", function(error, root) {
  if (error) throw error;

  Registry.findModules(query, function(error, modules) {
    if (error) throw error;
    if (!modules.length) return void console.error("no module found");

    for (var i = 0, n = modules.length; i < n; ++i) {
      console.log((i ? "✗" : "✓") + " " + modules[i]);
    }

    modules[0].findRelease("*", function(error, release) {
      if (error) throw error;
      console.log("✓ " + release);

      var file = path.join(root.dir, "crom_modules", crypto.createHash("sha256")
          .update(release.url)
          .digest("hex")
          + ".zip");

      release.download(fs.createWriteStream(file), function(error) {
        if (error) throw error;
        console.log("✓ " + file);
      });
    });
  });
});
